


<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Examples - Bonsai</title>
    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css" />
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
	  <link href="stylesheets/test.css" rel="stylesheet" media="screen" />
    <link href="favicon.ico" rel="icon" type="image/ico" />
      <script src="javascripts/all.js"></script>

    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WVB6MG2');</script>
<!-- End Google Tag Manager -->
      <!-- start Mixpanel -->
<script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
mixpanel.init("91fbf7b68fb2356f91916026f221ddd5", {
    loaded: function(mixpanel) {
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        distinct_id = getParameterByName('refUserId');
        if (distinct_id) {
          mixpanel.identify(distinct_id);
        }
    }
});</script>
<!-- end Mixpanel -->

  </head>

  <body class="examples" data-languages="[&quot;python&quot;,&quot;cpp&quot;]">


	  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WVB6MG2"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) --> 

  <div id="flex-container">

	<nav id="primary-nav">



	<div id="logo"> <a href="./"><img class="bonsai-logo" src="images/bonsai-logo.svg"></a></div>

	<label for="drop" class="toggle"><img class="menu-ham" src="images/menu.svg"></label>
	<input type="checkbox" id="drop" />

	<ul class="menu">

		<li class="header_menu_item "> <a href="guides/getting-started.html">Quick Start</a></li>

		<li class="header_menu_item"> <!-- First Tier Drop Down --> <label for="drop-1" class="toggle">Tutorials +</label><a  href="#">Tutorials</a>
			<input type="checkbox" id="drop-1"/>
			<ul id="tutorials">
				<li class=""> <a href="guides/cli-install-guide.html">Install the CLI</a>  </li>
				<li class=""> <a href="guides/sdk-install-guide.html">Install the SDK</a>  </li>
				<li class=""> <a href="guides/local-dev-guide.html">Run the Platform Locally</a>  </li>
				<li class=""> <a href="guides/jupyter-api-guide.html">Use Bonsai's API with Jupyter</a>  </li>
			</ul>
		</li>

		<li class="header_menu_item"> <!-- First Tier Drop Down --> <label for="drop-2" class="toggle">Guides +</label><a  href="#">Guides</a>
			<input type="checkbox" id="drop-2"/>
			<ul id="guides">
				<li class=""> <a href="guides/simulation-guide.html">Learn About Simulation Requirements</a>  </li>
				<li class=""> <a href="guides/inkling-guide.html">Learn the Inkling Language</a>  </li>
				<li class=""> <a href="guides/machine-teaching.html">Programming Machine Teaching</a>  </li>
				<li class=""> <a href="guides/ai-engine-guide.html">Understand AI Engine Components</a>  </li>
				<li class=""> <a href="guides/web-graphs-guide.html">Understand BRAIN Graphs</a>  </li>
			</ul>
		</li>

		<li class="header_menu_item"> <!-- First Tier Drop Down --> <label for="drop-3" class="toggle">References +</label><a  href="#">References</a>
			<input type="checkbox" id="drop-3"/>
			<ul id="references">
				<li class=""> <a href="references/api-reference.html">API Reference</a>  </li>
				<li class=""> <a href="references/cli-reference.html">CLI Reference</a>  </li>
				<li class=""> <a href="references/inkling-reference.html">Inkling Reference</a>  </li>
				<li class=""> <a href="references/library-reference.html">Library Reference</a>  </li>
				<li class=""> <a href="references/simulator-reference.html">Simulator Reference</a>
			</ul> 
		</li>

		<li class="header_menu_item selected"> <a href="examples.html">Examples</a></li>

		<li>
			<input type="search" id="docs-search" placeholder="Search Bonsai Docs">
		</li>


	</ul>

</nav>


	<div id="main-wrapper">

    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="tocify-wrapper">

        <div class="lang-selector">
              <a href="#" data-language-name="python">python</a>
              <a href="#" data-language-name="cpp">cpp</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div class="page-title">Examples</div>
      <div id="toc">
      </div>

			 
<ul class="toc-footer">

<li><a href='https://bons.ai'>Bonsai Home</a></li>
<li><a href='https://beta.bons.ai'>BRAIN Dashboard</a></li>
<li><a href='https://github.com/BonsaiAI/slate'>Contribute to the Docs</a></li>
<li><a href='http://pages.bons.ai/apply.html'>Apply for Bonsai Platform Preview</a></li>
<li><a href="/releases.html">Product Release Notes</a></li>
<li><a href='https://bons.ai/contact-us#contact-page-form'>Contact Us</a></li>

</ul>


	   <div class="cc-bottom">
	
	<div class="toc-footer bottom cc-info">

		<a href='https://creativecommons.org/licenses/by-sa/4.0/' class="cc-icon-width" >
			<svg class="cc" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
			viewBox="0 0 70.7 13.4" style="enable-background:new 0 0 70.7 13.4;" xml:space="preserve">

				<g>

				<g>
				<circle class="st0" cx="6.8" cy="6.7" r="6.1"/>
				<path d="M6.7,0c1.9,0,3.5,0.7,4.8,2c0.6,0.6,1.1,1.4,1.4,2.2c0.3,0.8,0.5,1.7,0.5,2.6c0,0.9-0.2,1.8-0.5,2.6
				c-0.3,0.8-0.8,1.5-1.4,2.1c-0.7,0.6-1.4,1.1-2.2,1.5c-0.8,0.3-1.7,0.5-2.6,0.5S5,13.3,4.2,12.9c-0.8-0.3-1.5-0.8-2.2-1.5
				s-1.1-1.4-1.5-2.2S0,7.6,0,6.7C0,5.8,0.2,5,0.5,4.2S1.3,2.6,2,2C3.3,0.7,4.8,0,6.7,0z M6.7,1.2c-1.5,0-2.8,0.5-3.9,1.6
				C2.3,3.4,1.9,4,1.6,4.6C1.4,5.3,1.2,6,1.2,6.7c0,0.7,0.1,1.4,0.4,2.1c0.3,0.7,0.7,1.3,1.2,1.8c0.5,0.5,1.1,0.9,1.8,1.2
				c0.7,0.3,1.4,0.4,2.1,0.4c0.7,0,1.4-0.1,2.1-0.4c0.7-0.3,1.3-0.7,1.8-1.2c1-1,1.6-2.3,1.6-3.9c0-0.7-0.1-1.4-0.4-2.1
				c-0.3-0.7-0.7-1.3-1.2-1.8C9.5,1.8,8.2,1.2,6.7,1.2z M6.6,5.6L5.7,6.1C5.6,5.9,5.5,5.7,5.4,5.6C5.3,5.6,5.1,5.5,5,5.5
				c-0.6,0-0.9,0.4-0.9,1.2c0,0.4,0.1,0.6,0.2,0.9C4.5,7.8,4.7,7.9,5,7.9c0.4,0,0.7-0.2,0.8-0.6l0.8,0.4C6.5,8.1,6.2,8.3,5.9,8.5
				c-0.3,0.2-0.7,0.3-1,0.3c-0.6,0-1.1-0.2-1.5-0.6C3.1,7.9,2.9,7.4,2.9,6.7c0-0.6,0.2-1.1,0.6-1.5c0.4-0.4,0.8-0.6,1.4-0.6
				C5.7,4.6,6.3,5,6.6,5.6z M10.5,5.6L9.6,6.1C9.5,5.9,9.4,5.7,9.3,5.6C9.1,5.6,9,5.5,8.9,5.5C8.3,5.5,8,5.9,8,6.7
				c0,0.4,0.1,0.6,0.2,0.9c0.2,0.2,0.4,0.3,0.7,0.3c0.4,0,0.7-0.2,0.8-0.6l0.8,0.4c-0.2,0.3-0.4,0.6-0.7,0.8c-0.3,0.2-0.7,0.3-1,0.3
				c-0.6,0-1.1-0.2-1.5-0.6C7,7.9,6.8,7.4,6.8,6.7c0-0.6,0.2-1.1,0.6-1.5c0.4-0.4,0.8-0.6,1.4-0.6C9.6,4.6,10.2,5,10.5,5.6z"/>
				</g>

				</g>
			</svg>
		</a>
		
		<a href='https://creativecommons.org/licenses/by-sa/4.0/'>Content:
		CC-BY-SA </a>
		
	</div>

</div>

    </div>

    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id="examples-overview">Examples Overview</h1>

<p>This page contains working examples of Inkling code in conjunction with python simulator files. All of these examples and the libraries that accompany them can be found on <a href="https://github.com/BonsaiAI">BonsaiAI&rsquo;s GitHub page</a> and are also linked within each Example.</p>

<p>All of the <strong>Python</strong> <strong>OpenAI Gym</strong>, and <strong>EnergyPlus</strong> examples can be trained in the cloud with Bonsai managed simulators. A full list of supported Docker containers for remotely managed simulators can be found in the <a href="references/cli-reference.html#bproj-file">Project File Reference</a>.</p>

<p>If you have any suggestions of examples you&rsquo;d like to see us implement please <a href="https://bons.ai/contact-us#contact-page-form">contact the support team</a>.</p>

<h3 id="custom-simulator-examples">Custom Simulator Examples</h3>

<ul>
<li><strong>Basic Python/C++ Simulation</strong>: A project called <em>Find the Center</em> which walks you through how to create a simple Inkling file that connects to a basic Python or C++ simulator.</li>
<li><strong>SimPy Elevator Simulation</strong>: A basic example of how to use SimPy to simulate a scenario. This one is an elevator dropping people off on 3 floors.</li>
</ul>

<h3 id="openai-gym-examples">OpenAI Gym Examples</h3>

<ul>
<li><strong>Cartpole</strong>: A simple control problem where a cart must make a simple move to keep a pole balanced on top.</li>
<li><strong>Mountain Car</strong>: A simple control problem where a car must build up enough momentum to climb a hill.</li>
</ul>

<h3 id="real-world-examples">Real World Examples</h3>

<ul>
<li><strong>HVAC with EnergyPlus</strong>: An example of climate control machine teaching using EnergyPlus and BCVTB for simulation. </li>
</ul>

<h3 id="simulink-examples">Simulink Examples</h3>

<ul>
<li><strong>Simulink Cartpole</strong>: The compiled Simulink version of a pole balancing on a cart.</li>
<li><strong>Simulink Househeat</strong>: The compiled Simulink version of an HVAC system taking into account the outdoor environment, the thermal characteristics of the house, and the house heating system.</li>
</ul>

          <h1 id="basic-python-c-simulation">Basic Python/C++ Simulation</h1>

<blockquote>
<p><img src="images/find-the-center.png" alt="Find the Center Diagram" /></p>
</blockquote>

<p><a href="https://github.com/BonsaiAI/bonsai-sdk/blob/master/samples/find-the-center-py"><strong>Download the full source code on GitHub</strong></a> if you want to run this simulator locally.</p>

<p>In this example, we&rsquo;ll walk you through the various statements that are part of the <em>Find the Center</em> game, including options for either a Python or C++ simulator file and the Inkling file. This is a very basic example of Inkling and how to connect to a custom simulator and shows the differences between using <code class="prettyprint">libbonsai</code> (C++) and the <code class="prettyprint">bonsai-ai</code> (Python) libraries.</p>

<p><em>Find the Center</em> is a simple game where the AI seeks the average value between two numbers. In this game, the AI begins at a random value of 0, 1, or 2. The AI then can move to a lower number by outputting -1, a higher number by outputting +1, or staying on the same number by outputting 0. The goal of <em>Find the Center</em> is to remain in the center of 0 and 2 (the number 1).</p>

<h2 id="inkling-file">Inkling File</h2>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">GameState</span>
    <span class="kr">Int8</span> <span class="nx">value</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">GameState</code> schema has one field, <code class="prettyprint">value</code>, with type <code class="prettyprint">Int8</code>.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">PlayerMove</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="nx">delta</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">PlayerMove</code> schema has one field, <code class="prettyprint">delta</code>, with type <code class="prettyprint">Int8</code>. The <code class="prettyprint">Int8</code> type is constrained to three possible values: -1, 0, and 1.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">SimConfig</span>
    <span class="kr">Int8</span> <span class="nx">dummy</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">SimConfig</code> schema has one field, <code class="prettyprint">dummy</code>, because there is no configuration needed in this particular example.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">concept</span> <span class="nx">find_the_center</span>
    <span class="k">is</span> <span class="nx">classifier</span>
    <span class="k">predicts</span> <span class="p">(</span><span class="nx">PlayerMove</span><span class="p">)</span>
    <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">GameState</span><span class="p">)</span>
    <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>This concept is named <code class="prettyprint">find_the_center</code>. <code class="prettyprint">find_the_center</code> expects input about the state of the game (defined by the <code class="prettyprint">GameState</code> schema) and replies with output defined by the <code class="prettyprint">PlayerMove</code> schema. This is the AI&rsquo;s next move in the simulation.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">simulator</span> <span class="nx">find_the_center_sim</span><span class="p">(</span><span class="nx">SimConfig</span><span class="p">)</span>
    <span class="k">action</span> <span class="p">(</span><span class="nx">PlayerMove</span><span class="p">)</span>
    <span class="k">state</span> <span class="p">(</span><span class="nx">GameState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">simulator</code> is called <code class="prettyprint">find_the_center_sim</code> (shown in #simulator-file) and takes the schema input of <code class="prettyprint">SimConfig</code> (even though it isn&rsquo;t configuring anything, it&rsquo;s required by the simulator). The <code class="prettyprint">find_the_center</code> concept will be trained using the <code class="prettyprint">find_the_center_sim</code> simulator. To define the training relationship between the simulator and the concept we must begin by defining the simulator. <code class="prettyprint">find_the_center_sim</code> expects an action defined in the <code class="prettyprint">PlayerMove</code> schema as input and replies with a state defined in the <code class="prettyprint">GameState</code> schema as output.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">curriculum</span> <span class="nx">find_the_center_curriculum</span>
    <span class="k">train</span> <span class="nx">find_the_center</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">find_the_center_sim</span>
    <span class="k">objective</span> <span class="nx">time_at_goal</span>
        <span class="k">lesson</span> <span class="nx">seek_center</span>
            <span class="k">configure</span>
                <span class="k">constrain</span> <span class="nx">dummy</span> <span class="k">with</span> <span class="kr">Int8</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">time_at_goal</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum is named <code class="prettyprint">find_the_center_curriculum</code>, and it trains the <code class="prettyprint">find_the_center</code> concept using the <code class="prettyprint">find_the_center_sim</code>.</p>

<p>This curriculum contains one lesson, called <code class="prettyprint">seek_center</code>. It configures the simulation, by setting a number of constraints for the state of the simulator. The lesson trains until the AI has maximized the objective <code class="prettyprint">time_at_goal</code>.</p>

<h2 id="simulator-file">Simulator File</h2>
<pre class="highlight python tab-python"><code><span class="s">""" This Basic simulator is for learning the simulator interface.
It can be used in this case to find the center between two numbers.
"""</span>
<span class="kn">import</span> <span class="nn">bonsai_ai</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>


<span class="k">class</span> <span class="nc">BasicSimulator</span><span class="p">(</span><span class="n">bonsai_ai</span><span class="o">.</span><span class="n">Simulator</span><span class="p">):</span>
    <span class="s">""" A basic simulator class that takes in a move from the inkling file,
    and returns the state as a result of that move.
    """</span>
    <span class="nb">min</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">max</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">goal</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">episode_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">""" called at the start of every episode. should
        reset the simulation and return the initial state
        """</span>

        <span class="c"># reset internal initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="nb">min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="nb">max</span><span class="p">)</span>

        <span class="c"># print out a message for our first episode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'started.'</span><span class="p">)</span>

        <span class="c"># return initial external state</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">"value"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="s">""" run a single step of the simulation.
        if the simulation has reached a terminal state, mark it as such.
        """</span>

        <span class="c"># perform the action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">action</span><span class="p">[</span><span class="s">"delta"</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># is this episode finished?</span>
        <span class="n">terminal</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="nb">min</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="nb">max</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">"value"</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">goal_count</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminal</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">bonsai_ai</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
    <span class="n">brain</span> <span class="o">=</span> <span class="n">bonsai_ai</span><span class="o">.</span><span class="n">Brain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">BasicSimulator</span><span class="p">(</span><span class="n">brain</span><span class="p">,</span> <span class="s">"find_the_center_sim"</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'starting...'</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">():</span>
        <span class="k">continue</span>

</code></pre><pre class="highlight cpp tab-cpp"><code><span class="c1">// Copyright (C) 2017 Bonsai, Inc.
</span>
<span class="cp">#include &lt;iostream&gt;
#include &lt;memory&gt;
#include &lt;string&gt;
#include &lt;random&gt;
</span>
<span class="cp">#include "bonsai/bonsai.hpp"
</span>
<span class="c1">// std
</span><span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">;</span>

<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="p">;</span>
<span class="k">using</span> <span class="n">std</span><span class="o">::</span><span class="n">uniform_int_distribution</span><span class="p">;</span>

<span class="c1">// bonsai
</span><span class="k">using</span> <span class="n">bonsai</span><span class="o">::</span><span class="n">Brain</span><span class="p">;</span>
<span class="k">using</span> <span class="n">bonsai</span><span class="o">::</span><span class="n">Config</span><span class="p">;</span>
<span class="k">using</span> <span class="n">bonsai</span><span class="o">::</span><span class="n">InklingMessage</span><span class="p">;</span>
<span class="k">using</span> <span class="n">bonsai</span><span class="o">::</span><span class="n">Simulator</span><span class="p">;</span>

<span class="c1">// random number generator
</span><span class="n">random_device</span> <span class="n">rd</span><span class="p">;</span>
<span class="n">mt19937</span> <span class="n">rng</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>

<span class="c1">// basic simulator
</span><span class="k">class</span> <span class="nc">BasicSimulator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Simulator</span> <span class="p">{</span>
    <span class="k">constexpr</span> <span class="k">static</span> <span class="kt">int8_t</span> <span class="n">_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">_goal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int8_t</span> <span class="n">_goal_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int8_t</span> <span class="n">_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">uniform_int_distribution</span><span class="o">&lt;</span><span class="kt">int8_t</span><span class="o">&gt;</span> <span class="n">_uni</span><span class="p">{</span><span class="n">_min</span><span class="p">,</span> <span class="n">_max</span><span class="p">};</span>
 <span class="k">public</span><span class="o">:</span>
    <span class="k">explicit</span> <span class="n">BasicSimulator</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Brain</span><span class="o">&gt;</span> <span class="n">brain</span><span class="p">,</span> <span class="n">string</span> <span class="n">name</span> <span class="p">)</span>
        <span class="o">:</span> <span class="n">Simulator</span><span class="p">(</span><span class="n">move</span><span class="p">(</span><span class="n">brain</span><span class="p">),</span> <span class="n">move</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{}</span>

    <span class="kt">void</span> <span class="n">episode_start</span><span class="p">(</span><span class="k">const</span> <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">params</span><span class="p">,</span>
        <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">initial_state</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">simulate</span><span class="p">(</span><span class="k">const</span> <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">action</span><span class="p">,</span>
        <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">,</span>
        <span class="kt">float</span><span class="o">&amp;</span> <span class="n">reward</span><span class="p">,</span>
        <span class="kt">bool</span><span class="o">&amp;</span> <span class="n">terminal</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">BasicSimulator</span><span class="o">::</span><span class="n">episode_start</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">params</span><span class="p">,</span>
    <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">initial_state</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// reset
</span>    <span class="n">_goal_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">_value</span> <span class="o">=</span> <span class="n">_uni</span><span class="p">(</span><span class="n">rng</span><span class="p">);</span>

    <span class="c1">// set intial state
</span>    <span class="n">initial_state</span><span class="p">.</span><span class="n">set_int8</span><span class="p">(</span><span class="s">"value"</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>

    <span class="c1">// print a message for our first episode
</span>    <span class="k">static</span> <span class="kt">bool</span> <span class="n">started</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">started</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">started</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"started."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BasicSimulator</span><span class="o">::</span><span class="n">simulate</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">action</span><span class="p">,</span>
    <span class="n">InklingMessage</span><span class="o">&amp;</span> <span class="n">state</span><span class="p">,</span>
    <span class="kt">float</span><span class="o">&amp;</span> <span class="n">reward</span><span class="p">,</span>
    <span class="kt">bool</span><span class="o">&amp;</span> <span class="n">terminal</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// perform the action
</span>    <span class="n">_value</span> <span class="o">+=</span> <span class="n">action</span><span class="p">.</span><span class="n">get_int8</span><span class="p">(</span><span class="s">"delta"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_value</span> <span class="o">==</span> <span class="n">_goal</span><span class="p">)</span>
        <span class="n">_goal_count</span><span class="o">++</span><span class="p">;</span>

    <span class="c1">// output
</span>    <span class="n">state</span><span class="p">.</span><span class="n">set_int8</span><span class="p">(</span><span class="s">"value"</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>
    <span class="n">terminal</span> <span class="o">=</span> <span class="n">_value</span> <span class="o">&lt;</span> <span class="n">_min</span> <span class="o">||</span> <span class="n">_value</span> <span class="o">&gt;</span> <span class="n">_max</span> <span class="o">||</span> <span class="n">_goal_count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="n">_goal_count</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">config</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Config</span><span class="o">&gt;</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">brain</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Brain</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>

    <span class="n">BasicSimulator</span> <span class="n">sim</span><span class="p">(</span><span class="n">brain</span><span class="p">,</span> <span class="s">"find_the_center_sim"</span><span class="p">);</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"starting..."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">sim</span><span class="p">.</span><span class="n">run</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>This is a basic simulator for learning the simulator library. In this case it is used to find the center between two numbers, 0 and 2. The goal, as outlined in the Inkling file, is to reach 1. The moves that the simulator is able to make are sent from the Inkling file to the simulator and the state of the simulator is sent back to Inkling.</p>

<p>The <a href="https://github.com/BonsaiAI/bonsai-sdk/blob/master/samples/find-the-center-py/README.md">README file</a> contained in the project has instructions for running this simulator in either Python or C++.</p>

          <h1 id="simpy-elevator-simulation">SimPy Elevator Simulation</h1>

<blockquote>
<p><img src="images/elevator_output.png" alt="ASCII Elevator Output" /></p>
</blockquote>

<p><a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/samples/elevator-sim"><strong>Download the full source code on GitHub</strong></a> if you want to run this simulator locally.</p>

<p>In this example, <a href="https://simpy.readthedocs.io/en/latest/index.html">SimPy</a>, a process-based discrete-event simulation framework based on standard Python, is used to simulate an elevator effectively transporting people to their desired floor. The simulated elevator gets rewarded by having people wait for the least amount of time. This example includes a simple elevator SimPy simulator, a Python simulation, and the simulation&rsquo;s Inkling file.</p>

<p>&ldquo;Processes in SimPy are defined by Python generator functions and may, for example, be used to model active components like customers, vehicles or agents. SimPy also provides various types of shared resources to model limited capacity congestion points (like servers, checkout counters and tunnels).&rdquo; - SimPy docs</p>

<p>This simulation is to provide actions (up, down, open doors) for an elevator, given floor requests from randomly arriving passengers. SimPy has a great framework for simulating time only when some state changes, which speeds up training for systems that would otherwise be mostly waiting.</p>

<p>In the image to the right, the elevator logs output every 100 seconds, then shows the state of the world, and then a list of recent passengers. The world state is the floor, the number of people waiting, plus the elevator, and the number of people inside.</p>

<p><code class="prettyprint">1: 0| 2: 1| 3: 0| [_1_]</code> shows zero people on the first floor, one person waiting on the second floor, and one person in the elevator on the third floor.</p>

<p>For more ideas of how SimPy can simulate real world problems see the <a href="https://simpy.readthedocs.io/en/latest/examples/index.html#examples">SimPy Examples page</a>.</p>

<h2 id="inkling-file">Inkling File</h2>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="c1"># Position is current location of elevator</span>
<span class="c1"># State of each floor: 1 if the floor is requested, 0 if not</span>
<span class="k">schema</span> <span class="nx">FloorState</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span> <span class="nx">Position</span><span class="p">,</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="nx">Floor1</span><span class="p">,</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="nx">Floor2</span><span class="p">,</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="nx">Floor3</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">FloorState</code> schema defines the dictionary returned from the Python simulation&rsquo;s <code class="prettyprint">advance</code> method to the BRAIN.</p>
<pre class="highlight inkling tab-inkling"><code><span class="c1"># command options: up, open, down</span>
<span class="k">schema</span> <span class="nx">Action</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">}</span> <span class="nx">command</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">Action</code> schema defines the possible actions the elevator can take. In this case the command given to the elevator is &lsquo;0&rsquo; is open, &lsquo;1&rsquo; is go up a floor, and &lsquo;2&rsquo; is go down a floor.</p>
<pre class="highlight inkling tab-inkling"><code><span class="c1"># Possible option for configuration</span>
<span class="k">schema</span> <span class="nx">ElevatorConfig</span>
    <span class="kr">Int8</span> <span class="nx">episode_length</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">ElevatorConfig</code> schema outlines some possible configurations you could give to the elevator if you wanted to tailor its learning in the lessons outlined later.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="c1"># Predicts an Action and follows input from the FloorState schema</span>
<span class="k">concept</span> <span class="nx">elevator_plan</span> <span class="k">is</span> <span class="nx">classifier</span>
    <span class="k">predicts</span> <span class="p">(</span><span class="nx">Action</span><span class="p">)</span>
    <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">FloorState</span><span class="p">)</span>
    <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>This concept is named <code class="prettyprint">elevator_plan</code>, a classifier, which predicts an <code class="prettyprint">Action</code> given the current <code class="prettyprint">FloorState</code>. In this simple example, we are training the concept to make an action (go up a floor, go down a floor, or open the doors) based on the current state of the floor the elevator is on.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="c1"># Connect to SimPy simulator for training</span>
<span class="k">simulator</span> <span class="nx">elevator_simulator</span><span class="p">(</span><span class="nx">ElevatorConfig</span><span class="p">)</span>
    <span class="k">action</span> <span class="p">(</span><span class="nx">Action</span><span class="p">)</span>
    <span class="k">state</span> <span class="p">(</span><span class="nx">FloorState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The simulator clause declares that a simulator named <code class="prettyprint">elevator_simulator</code> will be connecting to the server for training. This <code class="prettyprint">elevator_simulator</code> expects an action defined in the <code class="prettyprint">Action</code> schema as input and replies with a state defined in the <code class="prettyprint">FloorState</code> schema as output.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="c1"># This trains the concept using a single lesson</span>
<span class="c1"># Maximize the elevator_objective defined in elevator_simulator.py</span>
<span class="k">curriculum</span> <span class="nx">high_score_curriculum</span>
    <span class="k">train</span> <span class="nx">elevator_plan</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">elevator_simulator</span>
    <span class="k">objective</span> <span class="nx">elevator_objective</span>
        <span class="k">lesson</span> <span class="nx">get_high_score</span>
            <span class="k">configure</span>
                <span class="k">constrain</span> <span class="nx">episode_length</span> <span class="k">with</span> <span class="kr">Int8</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">elevator_objective</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum <code class="prettyprint">high_score_curriculum</code> trains <code class="prettyprint">elevator_plan</code> using <code class="prettyprint">elevator_simulator</code>. The BRAIN that runs this Inkling code will try to maximize the value returned from <code class="prettyprint">elevator_objective</code> until you stop training. The reward function passed to <code class="prettyprint">elevator_objective</code> is a method in the simulator <code class="prettyprint">elevator_simulator.py</code> in which it returns the waiting time of the total sum of people as a negative number, in order to maximize it. The code for this can be seen at the end of the simulator excerpt below.</p>

<p>This curriculum contains one simple lesson, called <code class="prettyprint">get_high_score</code>. It configures the simulation, but in this case the lesson is simply using a dummy variable to not provide the elevator with any starting conditions to learn from. The training starts from random placement and actions.</p>

<h2 id="simulator-excerpt">Simulator Excerpt</h2>
<pre class="highlight python tab-python"><code><span class="c"># Excerpt of simulator class from the elevator_simulator.py file</span>

<span class="k">class</span> <span class="nc">ElevatorSimulator</span><span class="p">(</span><span class="n">Simulator</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">episode_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'called episode_start'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="n">floors</span> <span class="o">=</span> <span class="p">[</span><span class="n">simpy</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BUILDING_SIZE</span><span class="p">)]</span>
        <span class="n">store</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">elevator</span><span class="o">.</span><span class="n">Lstate</span><span class="p">()</span>
        <span class="n">person_score</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">elevator</span><span class="o">.</span><span class="n">claim</span><span class="p">(</span><span class="n">floors</span><span class="p">,</span> <span class="n">reqs</span><span class="p">))</span>
        <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">elevator</span><span class="o">.</span><span class="n">person_generator</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">floors</span><span class="p">,</span> <span class="n">person_score</span><span class="p">))</span>
        <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">elevator</span><span class="o">.</span><span class="n">display_process</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">person_score</span><span class="p">,</span> <span class="n">state</span><span class="p">))</span>

        <span class="c"># We use the single step version of elevator (elevator_one)</span>
        <span class="c"># this allows the simulator to run until the elevator uses a command.</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">elevator</span><span class="o">.</span><span class="n">elevator_one</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">floors</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">reqs</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">floors</span> <span class="o">=</span> <span class="n">floors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person_score</span> <span class="o">=</span> <span class="n">person_score</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span> <span class="o">=</span> <span class="n">reqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ep</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">'command'</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="c"># print('[advance]', end='')</span>
        <span class="c"># print('command: {}'.format(command))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c"># pass our command to a resource by way of this doit() method</span>
        <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">doit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span>

        <span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">elevator</span><span class="o">.</span><span class="n">elevator_one</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">floors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span><span class="p">))</span>
        <span class="c"># print('stepped to {}'.format(env.now))</span>

        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">()</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_done</span><span class="p">()</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># only calculate reward for training mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">:</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elevator_objective</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_state</span><span class="p">(),</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span>

    <span class="k">def</span> <span class="nf">_get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">""" return the current state of the simulation """</span>

        <span class="c"># print('[get_state]', end='')</span>

        <span class="c"># if a floor is requested, state=1</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">queue</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">floors</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Floor{}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)}</span>
        <span class="n">state</span><span class="p">[</span><span class="s">'Position'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">floor</span>
        <span class="c"># print(state)</span>

        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_get_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">SIM_TIME</span>
        <span class="k">return</span> <span class="n">done</span>

    <span class="k">def</span> <span class="nf">_elevator_objective</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># print('[objective]', end='')</span>
        <span class="n">waiting</span> <span class="o">=</span> <span class="n">elevator</span><span class="o">.</span><span class="n">count_waiting</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">person_score</span><span class="p">)</span>
        <span class="c"># print("returning score %d for %d people" % (active, len(scores)))</span>

        <span class="c"># return as negative because the simulator maximizes this value.</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">waiting</span>
</code></pre>
<p>The full simulator file <em>elevator_simulator.py</em> and elevator simulation file <em>elevator.py</em> for this example is with the rest of the <a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/samples/elevator-sim">simpy-elevator code</a> on GitHub.</p>

<p>This is a Python simulator which uses the elevator.py custom Python simulation using SimPy. This <em>elevator_simulator.py</em> file repeatedly runs the elevator simulation for each episode of training to get details of where people start out, how many are on the elevator, and what floor they are going to, etc. Each episode the curriculum in Inkling trains the concept by sending a new <code class="prettyprint">Action</code> to the BRAIN based on the <code class="prettyprint">FloorState</code> of the simulator.</p>

<p>The <code class="prettyprint">_elevator_objective</code> function returns a negative waiting value because this value is going to be maximized, and we want to actually minimize the collective group of people&rsquo;s wait time.</p>

<p>For more information on the functions inside of this simulator class and how to implement them see the <a href="http://docs.bons.ai/references/library-reference.html">Library Reference</a>.</p>

<p>Also note that if you would like to see how this simulator can be run without Bonsai - to demonstrate how the emulator behaves with a hard-coded algorithm - you can do so by running elevator.py simply with Python itself.</p>

          <h1 id="openai-gym-cartpole">OpenAI Gym: Cartpole</h1>

<blockquote>
<p><img src="images/cart-pole-balance.gif" alt="Cartpole Balance" /></p>
</blockquote>

<p><a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/samples/openai-gym/gym-cartpole-sample"><strong>Download the full source code on GitHub</strong></a> if you want to run this simulator locally. If you want to run Cartpole remotely on the Bonsai Platform as a managed simulator, create a new BRAIN selecting the Cartpole demo on <a href="https://beta.bons.ai/new">beta.bons.ai</a>.</p>

<p>In this example, we&rsquo;ll walk you through the various statements that are part of the Cartpole Inkling file. Each statement is followed by an explanation of the statement.</p>

<p>Cartpole is a classic control problem. <a href="https://gym.openai.com/envs/CartPole-v1">OpenAI Gym</a> describes it as:</p>

<p><em>A pole is attached by an un-actuated joint to a cart, which moves along a frictionless track. The system is controlled by applying a force of +1 or -1 to the cart. The pendulum starts upright, and the goal is to prevent it from falling over. A reward of +1 is provided for every timestep that the pole remains upright. The episode ends when the pole is more than 15 degrees from vertical, or the cart moves more than 2.4 units from the center.</em></p>

<h2 id="inkling-file">Inkling File</h2>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">GameState</span>
    <span class="kr">Float32</span> <span class="nx">position</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">velocity</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">angle</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">rotation</span>
<span class="k">end</span>
</code></pre>
<p>The schema <code class="prettyprint">GameState</code> names four records  <code class="prettyprint">position</code>, <code class="prettyprint">velocity</code>, <code class="prettyprint">angle</code>, and <code class="prettyprint">rotation</code>  and assigns a type to them. This information is input from the simulation.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">Action</span>
    <span class="kr">Int8</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="nx">command</span>
<span class="k">end</span>
</code></pre>
<p>The schema <code class="prettyprint">Action</code> names a record  <code class="prettyprint">action</code>   and assigns it a constrained type.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">CartPoleConfig</span>
    <span class="kr">Int8</span> <span class="nx">episode_length</span><span class="p">,</span>
    <span class="kr">UInt8</span> <span class="nx">deque_size</span>
<span class="k">end</span>
</code></pre>
<p>The schema <code class="prettyprint">CartPoleConfig</code> names two records  <code class="prettyprint">episode_length</code> and
 <code class="prettyprint">deque_size</code>  and assigns each of them a type.   <code class="prettyprint">episode_length</code> is a signed <code class="prettyprint">Int8</code> because -1 is used for &ldquo;run until pole drops&rdquo;.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">concept</span> <span class="nx">balance</span> <span class="k">is</span> <span class="nx">classifier</span>
    <span class="k">predicts</span> <span class="p">(</span><span class="nx">Action</span><span class="p">)</span>
    <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">GameState</span><span class="p">)</span>
    <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>The concept is named <code class="prettyprint">balance</code>, and it takes input from the simulator. That input is the records in the schema <code class="prettyprint">GameState</code>. The balance concept outputs the move the AI should make in the simulator. This output is the record in the <code class="prettyprint">Action</code> schema.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">simulator</span> <span class="nx">cartpole_simulator</span><span class="p">(</span><span class="nx">CartPoleConfig</span><span class="p">)</span> 
    <span class="k">action</span> <span class="p">(</span><span class="nx">Action</span><span class="p">)</span>
    <span class="k">state</span> <span class="p">(</span><span class="nx">GameState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">cartpole_simulator</code> gets information from two schemas. The first schema, <code class="prettyprint">CartPoleConfig</code>, specifies the schema for configuration of the simulation. The second schema contains the state of the simulator that is sent to the lesson.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">curriculum</span> <span class="nx">balance_curriculum</span>
    <span class="k">train</span> <span class="nx">balance</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">cartpole_simulator</span>
    <span class="k">objective</span> <span class="nx">open_ai_gym_default_objective</span>

        <span class="k">lesson</span> <span class="nx">balancing</span>
            <span class="k">configure</span>
                <span class="k">constrain</span> <span class="nx">episode_length</span> <span class="k">with</span> <span class="kr">Int8</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">},</span>
                <span class="k">constrain</span> <span class="nx">deque_size</span> <span class="k">with</span> <span class="kr">UInt8</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">open_ai_gym_default_objective</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum&rsquo;s name is <code class="prettyprint">balance_curriculum</code>. It trains the <code class="prettyprint">balance</code> concept with the <code class="prettyprint">cartpole_simulator</code>. The objective for this curriculum is <code class="prettyprint">up_time</code>. The objective measures how long the pole stays upright.</p>

<p>This curriculum contains one lesson, called <code class="prettyprint">balancing</code>. It configures the simulation, by setting two constraints for the state of the simulator. The lesson trains until the AI has maximized the objective.</p>

<h2 id="simulator-file">Simulator File</h2>
<pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">bonsai_ai</span> <span class="kn">import</span> <span class="n">Brain</span><span class="p">,</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">bonsai_gym</span> <span class="kn">import</span> <span class="n">GymSimulator</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">'gym_simulator'</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CartPole</span><span class="p">(</span><span class="n">GymSimulator</span><span class="p">):</span>
    <span class="c"># Environment name, from openai-gym</span>
    <span class="n">environment_name</span> <span class="o">=</span> <span class="s">'CartPole-v0'</span>

    <span class="c"># simulator name from Inkling</span>
    <span class="c"># Example Inkling:</span>
    <span class="c">#   curriculum balance_curriculum</span>
    <span class="c">#       train balance</span>
    <span class="c">#       with simulator cartpole_simulator</span>
    <span class="c">#       ....</span>
    <span class="n">simulator_name</span> <span class="o">=</span> <span class="s">'cartpole_simulator'</span>

    <span class="c"># convert openai gym observation to our state schema</span>
    <span class="c"># Example Inkling:</span>
    <span class="c">#   schema GameState</span>
    <span class="c">#       Float32 position,</span>
    <span class="c">#       Float32 velocity,</span>
    <span class="c">#       Float32 angle,</span>
    <span class="c">#       Float32 rotation</span>
    <span class="c">#   end</span>
    <span class="k">def</span> <span class="nf">gym_to_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">'position'</span><span class="p">:</span> <span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="s">'velocity'</span><span class="p">:</span> <span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="s">'angle'</span><span class="p">:</span>    <span class="n">observation</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="s">'rotation'</span><span class="p">:</span> <span class="n">observation</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="c"># convert our action schema into openai gym action</span>
    <span class="c"># Example Inkling:</span>
    <span class="c">#   schema Action</span>
    <span class="c">#       Int8{0, 1} command</span>
    <span class="c">#   end</span>
    <span class="k">def</span> <span class="nf">action_to_gym</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">action</span><span class="p">[</span><span class="s">'command'</span><span class="p">]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="c"># create a brain, openai-gym environment, and simulator</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">CartPole</span><span class="p">(</span><span class="n">brain</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run_gym</span><span class="p">()</span>
</code></pre>
<p>This is an OpenAI Gym example which uses the OpenAI environment as its simulator. For more information about the simulator used see the <a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/bonsai-gym">Bonsai Gym Common GitHub repo</a> which is a python library for integrating a Bonsai BRAIN with OpenAI Gym environments.</p>

          <h1 id="openai-gym-mountain-car">OpenAI Gym: Mountain Car</h1>

<blockquote>
<p><img src="images/mountain-car-control.gif" alt="Mountain Car Control" /></p>
</blockquote>

<p><a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/samples/openai-gym/gym-mountaincar-continuous-sample"><strong>Download the full source code on GitHub</strong></a> if you want to run this simulator locally. If you want to run Mountain Car remotely on the Bonsai Platform as a managed simulator, create a new BRAIN selecting the Mountain Car demo on <a href="https://beta.bons.ai/new">beta.bons.ai</a></p>

<p>We&rsquo;ve used pieces of code from this example in several places, but here we&rsquo;ll walk you through all the various statements that are part of the Mountain Car Inkling file. Each statement is followed by an explanation of the statement.</p>

<p>Mountain Car is a classic control problem. <a href="https://gym.openai.com/envs/MountainCarContinuous-v0/">OpenAI Gym</a> describes it as:</p>

<p><em>A car is on a one-dimensional track, positioned between two &ldquo;mountains&rdquo;. The goal is to drive up the mountain on the right; however, the car&rsquo;s engine is not strong enough to scale the mountain in a single pass. Therefore, the only way to succeed is to drive back and forth to build up momentum.</em></p>

<h2 id="inkling-file">Inkling File</h2>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">GameState</span>
    <span class="kr">Float32</span> <span class="nx">x_position</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">x_velocity</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">GameState</code> schema names two records  <code class="prettyprint">x_position</code> and <code class="prettyprint">y_position</code>  and assigns a type to them.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">Action</span>
    <span class="kr">Float32</span><span class="p">{</span><span class="o">-</span><span class="mf">1.0</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span> <span class="nx">command</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">Action</code> schema names a single record  <code class="prettyprint">command</code>  and assigns a constrained type to it.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">MountainCarConfig</span>
    <span class="kr">UInt8</span> <span class="nx">deque_size</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">MountainCarConfig</code> schema names a single record - <code class="prettyprint">deque_size</code> - and assigns an unconstrained type to it.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">concept</span> <span class="nx">high_score</span> <span class="k">is</span> <span class="nx">classifier</span>
    <span class="k">predicts</span> <span class="p">(</span><span class="nx">Action</span><span class="p">)</span>
    <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">GameState</span><span class="p">)</span>
    <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>The concept is named <code class="prettyprint">high_score</code>, and it takes input from the simulator about the state of the game (<code class="prettyprint">GameState</code> schema). It outputs to the <code class="prettyprint">Action</code> schema. This is the AI&rsquo;s next move in the game.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">simulator</span> <span class="nx">mountaincar_continuous_simulator</span><span class="p">(</span><span class="nx">MountainCarConfig</span><span class="p">)</span>
   <span class="k">action</span>  <span class="p">(</span><span class="nx">Action</span><span class="p">)</span>
   <span class="k">state</span>  <span class="p">(</span><span class="nx">GameState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">mountaincar_continuous_simulator</code> gets information from two schemas. The first schema, <code class="prettyprint">MountainCarConfig</code>, specifies the schema for configuration of the simulation. The second schema contains the state of the simulator that is sent to the lesson.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">curriculum</span> <span class="nx">high_score_curriculum</span>
    <span class="k">train</span> <span class="nx">high_score</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">mountaincar_continuous_simulator</span>
    <span class="k">objective</span> <span class="nx">open_ai_gym_default_objective</span>

        <span class="k">lesson</span> <span class="nx">get_high_score</span>
            <span class="k">configure</span>
                <span class="k">constrain</span> <span class="nx">deque_size</span> <span class="k">with</span> <span class="kr">UInt8</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">open_ai_gym_default_objective</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum is named <code class="prettyprint">high_score_curriculum</code>, and it trains the <code class="prettyprint">high_score</code> concept using the <code class="prettyprint">mountaincar_simulator</code>. This curriculum contains one lesson, called <code class="prettyprint">get_high_score</code>. It configures the simulation, by setting two constraints for the state of the simulator.</p>

<p>The lesson trains until the AI has maximized the objective named <code class="prettyprint">score</code>.</p>

<h2 id="simulator-file">Simulator File</h2>
<pre class="highlight python tab-python"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">bonsai_ai</span> <span class="kn">import</span> <span class="n">Brain</span><span class="p">,</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">bonsai_gym</span> <span class="kn">import</span> <span class="n">GymSimulator</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">'gym_simulator'</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MountainCarContinuous</span><span class="p">(</span><span class="n">GymSimulator</span><span class="p">):</span>
    <span class="n">environment_name</span> <span class="o">=</span> <span class="s">'MountainCarContinuous-v0'</span>
    <span class="n">simulator_name</span> <span class="o">=</span> <span class="s">'mountaincar_continuous_simulator'</span>

    <span class="k">def</span> <span class="nf">gym_to_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="p">{</span><span class="s">'x_position'</span><span class="p">:</span> <span class="n">observation</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="s">'x_velocity'</span><span class="p">:</span> <span class="n">observation</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="c"># As an Estimator, continuous mountaincar returns the command</span>
    <span class="c"># as a numpy array.</span>
    <span class="k">def</span> <span class="nf">action_to_gym</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="c"># return actions['command']</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">actions</span><span class="p">[</span><span class="s">'command'</span><span class="p">]])</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="c"># create a brain, openai-gym environment, and simulator</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">brain</span> <span class="o">=</span> <span class="n">Brain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">MountainCarContinuous</span><span class="p">(</span><span class="n">brain</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run_gym</span><span class="p">()</span>
</code></pre>
<p>This is an OpenAI Gym example which uses the OpenAI environment as its simulator. For more information about the simulator used see the <a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/bonsai-gym">Bonsai Gym Common GitHub repo</a> which is a python library for integrating a Bonsai BRAIN with OpenAI Gym environments.</p>

          <h1 id="energyplus-hvac-optimization">EnergyPlus HVAC Optimization</h1>

<blockquote>
<p><img src="images/energyplus-graph.png" alt="EnergyPlus Graph" /></p>
</blockquote>

<p><a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/samples/energyplus-sample"><strong>Download the full source code on GitHub</strong></a> if you want to run this simulator locally. If you want to run EnergyPlus remotely on the Bonsai Platform as a managed simulator, create a new BRAIN selecting the EnergyPlus demo on <a href="https://beta.bons.ai/new">beta.bons.ai</a>.</p>

<p>In this example, we&rsquo;ll walk you through the various statements that are part of a sample implementation of <a href="https://energyplus.net/">EnergyPlus</a> on the Bonsai Platform, including the simulator and the Inkling files. This is a real-world example of how to use the Bonsai Platform for HVAC control using BCVTB and EnergyPlus.</p>

<p>While this BRAIN is training, the Bonsai AI Engine launches the EnergyPlus simulator in the background for every episode. The <em>energyplus_simulator.py</em> then drives the simulator forward a step at a time until it finishes the episode and then relaunches it for the next episode, driving the actions into it and sending state results back to the Bonsai AI Engine.</p>

<h2 id="inkling-file">Inkling File</h2>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">SimState</span>
    <span class="kr">Int32</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">}</span> <span class="nx">SolarIrradiation</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">SimState</code> schema defines the dictionary returned from the Python simulation&rsquo;s <code class="prettyprint">advance</code> method to the BRAIN.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">SimAction</span>
    <span class="kr">Int32</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span> <span class="nx">shade</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">SimAction</code> schema defines the &lsquo;actions&rsquo;, a dictionary of control signals this AI can send to the climate control. For example: <code class="prettyprint">shade</code> == night, off, day.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">SimConfig</span>
    <span class="kr">Int32</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span> <span class="nx">unused</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">SimConfig</code> schema in this case is not used (but is still required to be defined in Inkling) but it would define the dictionary passed as a parameter to the <code class="prettyprint">set_properties</code> method of the Python simulator.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">concept</span> <span class="nx">my_concept</span> <span class="k">is</span> <span class="nx">classifier</span>
   <span class="k">predicts</span> <span class="p">(</span><span class="nx">SimAction</span><span class="p">)</span>
   <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">SimState</span><span class="p">)</span>
   <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>This concept is named <code class="prettyprint">my_concept</code> which predicts a <code class="prettyprint">SimAction</code> given a <code class="prettyprint">SimState</code>. In this simple demo we just ask the Bonsai Platform to generate any model that can learn to control the server using these inputs and outputs.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">simulator</span> <span class="nx">energyplus_simulator</span><span class="p">(</span><span class="nx">SimConfig</span><span class="p">)</span>
    <span class="k">action</span> <span class="p">(</span><span class="nx">SimAction</span><span class="p">)</span>
    <span class="k">state</span> <span class="p">(</span><span class="nx">SimState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The simulator clause declares that a simulator named <code class="prettyprint">energyplus_simulator</code> will be connecting to the server for training. This code snippet binds the previous schemas to this simulator. To define the training relationship between the simulator and the concept we must begin by defining the simulator. <code class="prettyprint">energyplus_simulator</code> expects an action defined in the <code class="prettyprint">SimAction</code> schema as input and replies with a state defined in the <code class="prettyprint">SimState</code> schema as output.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">curriculum</span> <span class="nx">my_curriculum</span>
    <span class="k">train</span> <span class="nx">my_concept</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">energyplus_simulator</span>
    <span class="k">objective</span> <span class="nx">reward_function</span>
        <span class="k">lesson</span> <span class="nx">my_first_lesson</span>
            <span class="k">configure</span>
                <span class="k">constrain</span> <span class="nx">unused</span> <span class="k">with</span> <span class="kr">Int32</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">reward_function</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum <code class="prettyprint">my_curriculum</code> trains <code class="prettyprint">my_concept</code> using <code class="prettyprint">energyplus_simulator</code>. The BRAIN that runs this Inkling code will try to maximize the value returned from <code class="prettyprint">reward_function</code> until you stop training. <code class="prettyprint">reward_function</code> is a method in the Python simulator.</p>

<p>This curriculum contains one lesson, called <code class="prettyprint">my_first_lesson</code>. It configures the simulation, by setting a number of constraints for the state of the simulator.</p>

<h2 id="simulator-excerpt">Simulator Excerpt</h2>
<pre class="highlight python tab-python"><code><span class="c"># Excerpt of simulator class from the energyplus_simulator.py file</span>

<span class="k">class</span> <span class="nc">EnergyPlusSimulator</span><span class="p">(</span><span class="n">Simulator</span><span class="p">):</span>
    <span class="s">"""
    Runs the Actuator model for training or prediction by launching it
    against the Ptolemy server above. This uses the Bonsai Simulator
    base class to interface with the BRAIN server.
    """</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ePlus85Actuator</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">clientState</span> <span class="o">=</span> <span class="p">{</span><span class="s">'SolarIrradiation'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">shade</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">is_terminal</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">episode_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="s">"""
        Callback called when an training episode starts. We use this
        to reset the Ptolemy server and start a new simulation session.
        Returns the initial state.
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restartPtolemyServer</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientState</span>

    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="s">"""
        Callback called  when stepping the simulation. It sends actions to the
        model and returns the state of the simulation to the BRAIN.
        """</span>

        <span class="c"># take the action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shade</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">'shade'</span><span class="p">]</span> <span class="o">*</span> <span class="mf">6.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restartPtolemyServer</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">writeToClient</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">shade</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readFromPtolemyClient</span><span class="p">()</span>

        <span class="c"># you like graphs? WE HAVE GRAPHS. SO MANY GRAPHS.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span><span class="p">:</span>
            <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grapher</span><span class="p">()</span>
            <span class="n">write_graph</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

            <span class="c"># clear old data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[])</span>

        <span class="n">reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_function</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clientState</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">reward</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span>

    <span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Called at the end of the simulation to output the graph.
        """</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">grapher</span><span class="p">()</span>
        <span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s">"graph.html"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">readFromPtolemyClient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Utility method used to do the read portion of the exchange
        with the Ptolemy server and client.
        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">readFromClient</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clientState</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">'SolarIrradiation'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
                <span class="p">}</span>

            <span class="c"># save the client input in our graph</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span><span class="p">)):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="c"># scale some of the values for readability</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">/=</span> <span class="mf">100.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exitFlag</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">restartPtolemyServer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Used to restart the server and setup the initial state.
        """</span>

        <span class="c"># set some default values for get_state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_terminal</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clientState</span> <span class="o">=</span> <span class="p">{</span><span class="s">'SolarIrradiation'</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="c"># close the old connections if they're still open</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># star a new episode</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"EnergyPlusSimulator: starting PtolemyServer"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">PtolemyServer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">waitForClient</span><span class="p">()</span>
            <span class="c"># get initial state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readFromPtolemyClient</span><span class="p">()</span>

        <span class="k">except</span> <span class="nb">OSError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"EnergyPlusSimulator: error on restart:"</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">reward_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Calculates the reward for the current state of the simulation
        """</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"EnergyPlusSimulator: reward_function"</span><span class="p">)</span>

        <span class="c"># largest reward is best reward (maximize)</span>
        <span class="n">reward</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c"># SolarIrradiation === Shades down === good</span>
            <span class="n">SolarIrradiation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fromClient</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.</span>

            <span class="c"># sun is down</span>
            <span class="k">if</span> <span class="n">SolarIrradiation</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c"># shades on</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># shade off</span>

            <span class="c"># sun is out</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shade</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c"># shades on</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reward</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c"># shades off</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">"EnergyPlusSimulator reward:"</span><span class="p">,</span> <span class="n">reward</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reward</span>
</code></pre>
<p>The full simulator file <em>energyplus_simulator.py</em> for this example is with the rest of the <a href="https://github.com/BonsaiAI/bonsai-sdk/tree/master/samples/energyplus-sample">energyplus-sample code</a> on GitHub.</p>

<p>This is a Python simulator for integrating the EnergyPlus simulator into the Bonsai AI Engine. This <em>energyplus_simulator.py</em> file repeatedly runs the EnergyPlus simulator in the background with new actions sent from the Bonsai AI Engine by passing the state from EnergyPlus to the backend, and the action from the backend back to EnergyPlus.</p>

<p>For more information on the functions inside of this simulator class and how to implement them see the <a href="http://docs.bons.ai/references/library-reference.html">Library Reference</a>.</p>

          <h1 id="simulink-examples">Simulink Examples</h1>

<p><strong>Simulink</strong>, developed by The MathWorks, is a graphical programming environment for modeling, simulating and analyzing multi-domain dynamical systems.</p>

<p>Bonsai is using <strong>Simulink</strong> as a training environment for a Bonsai BRAIN. Were supporting a wide range of classical control or machine tuning use cases. Please review our simulator and <a href="http://docs.bons.ai/guides/simulation-guide.html"><strong>simulation model requirements guide</strong></a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<blockquote>
<p>You can also clone the repo on GitHub</p>
</blockquote>
<pre class="highlight shell tab-shell"><code>git clone https://github.com/BonsaiAI/bonsai-simulink
</code></pre>
<p>Installation covered within the specific example.</p>

<ul>
<li>Python3</li>
<li>Bonsai CLI and SDK</li>
<li>Asynchronous HTTP Client/Server</li>
<li>MATLAB Engine API for Python</li>
<li>MATLAB &amp; Simulink (R2017b)</li>
</ul>

<p><a href="https://github.com/BonsaiAI/bonsai-simulink/archive/master.zip"><strong>Download the full source code</strong></a></p>

<h2 id="simulink-cartpole">Simulink Cartpole</h2>

<p>This is a step-by-step guide for using <strong>Bonsai&rsquo;s Universal Coordinator</strong> in Python to connect the Bonsai Platform to a Simulink model.</p>

<p>You have to have Matlab and Simulink installed. You can download the trial version from <a href="http://www.themathworks.com">TheMathworks</a></p>

<h4 id="cli-guide">CLI guide</h4>

<p>We&rsquo;re using the Bonsai Command Line Interface (CLI) for this example. Refer to the <a href="http://docs.bons.ai/guides/cli-install-guide.html"><strong>Bonsai CLI guide</strong></a> for more details.</p>

<h4 id="install-pre-requisites">Install Pre-Requisites</h4>
<pre class="highlight plaintext"><code>pip install aiohttp
pip install bonsai-cli bonsai-ai bonsai-gym
</code></pre>
<p>Install Asynchronous HTTP Client/Server and the Bonsai CLI and Bonsai libraries needed to run our examples.</p>

<h4 id="install-matlab-dependencies">Install Matlab Dependencies:</h4>
<pre class="highlight plaintext"><code>cd &lt;matlabroot&gt;/extern/engines/python
python setup.py install
</code></pre>
<p>Install the Matlab API for Python from the root directory of your Matlab installation.</p>

<p>This example requires the installation of <strong>Matlab Simscape Multibody Add-On</strong>.</p>

<p>Go to your Add-On Explorer in Matlab and add Simscape and Simscape Multibody.</p>

<h4 id="running-and-training">Running and Training</h4>
<pre class="highlight plaintext"><code>bonsai create simulink-cartpole
bonsai push
bonsai train start



../../coordinator/coordinator --brain=simulink-cartpole
</code></pre>
<p>Run the following in the simulink-househeat directory:</p>

<p>The <code class="prettyprint">bonsai push</code> command will upload all needed files to the Bonsai backend. This includes an <a href="http://docs.bons.ai/references/inkling-reference.html"><strong>Inkling</strong></a> file which describes state, actions and a learning curriculum that the the Bonsai AI is using for training.</p>

<h6 id="inkling">Inkling</h6>

<p>Inkling is a declarative, strongly typed programming language specifically designed for artificial intelligence (AI). It abstracts away the world of dynamic AI algorithms that require expertise in machine learning and enables more developers to program AI.
Please review our <a href="http://docs.bons.ai/guides/inkling-guide.html#overview"><strong>Inkling Guide</strong></a></p>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">CartpoleState</span>
    <span class="kr">Float32</span> <span class="nx">theta</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">dtheta</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">x</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">dx</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">CartpoleState</code> schema names four records  <code class="prettyprint">theta</code>, <code class="prettyprint">dtheta</code>,<code class="prettyprint">x,</code> and <code class="prettyprint">dx</code>  and assigns a type to them.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">CartpoleAction</span>
    <span class="kr">Float32</span> <span class="p">{</span><span class="o">-</span><span class="mf">10.0</span><span class="p">:</span><span class="mf">10.0</span><span class="p">}</span> <span class="nx">f</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">CartpoleAction</code> schema names a single record  <code class="prettyprint">action</code>  and assigns a constrained type to it.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">CartpoleConfig</span>
    <span class="kr">Int8</span> <span class="nx">dummy</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">CartpoleConfig</code> uses <code class="prettyprint">dummy</code> because we&rsquo;re not using config in this model.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">concept</span> <span class="nx">balance</span> <span class="k">is</span> <span class="nx">estimator</span>
   <span class="k">predicts</span> <span class="p">(</span><span class="nx">CartpoleAction</span><span class="p">)</span>
   <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">CartpoleState</span><span class="p">)</span>
   <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>The concept, <code class="prettyprint">balance</code>, takes input from the simulator about the state of the model (<code class="prettyprint">Cartpolestate</code> schema). It outputs to the <code class="prettyprint">CartpoleAction</code> schema. This is the AI&rsquo;s next control signal to the cartpole.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">simulator</span> <span class="nx">simulink_sim</span><span class="p">(</span><span class="nx">CartpoleConfig</span><span class="p">)</span>
    <span class="k">action</span> <span class="p">(</span><span class="nx">CartpoleAction</span><span class="p">)</span>
    <span class="k">state</span> <span class="p">(</span><span class="nx">CartpoleState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">simulink_sim</code> gets information from two schemas. The first schema, <code class="prettyprint">action</code>, specifies the schema for actions within the simulation. The second schema contains the <code class="prettyprint">state</code> of the simulator sent to the lesson.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">curriculum</span> <span class="nx">my_curriculum</span>
    <span class="k">train</span> <span class="nx">balance</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">simulink_sim</span>
    <span class="k">objective</span> <span class="nx">cartpole_balance</span>
        <span class="k">lesson</span> <span class="nx">my_first_lesson</span>
            <span class="k">configure</span>
                <span class="k">constrain</span> <span class="nx">dummy</span> <span class="k">with</span> <span class="kr">Int8</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">cartpole_balance</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum, <code class="prettyprint">my_curriculum</code>, trains the <code class="prettyprint">balance</code> concept using the <code class="prettyprint">simulink_sim</code>. This curriculum contains one lesson, called <code class="prettyprint">my_first_lesson</code>. It configures the simulation, by setting a constraint for the state of the simulator.</p>

<p>The lesson trains until the AI has maximized the objective named <code class="prettyprint">cartpole_balance</code>.</p>

<h6 id="predicting-with-a-brain">Predicting with a BRAIN</h6>
<pre class="highlight plaintext"><code>bonsai train stop
</code></pre>
<p>When you are seeing rewards reaching 1000 you can stop training. You may need to Ctrl+C to stop in the terminal.</p>
<pre class="highlight plaintext"><code>../../coordinator/coordinator --predict
</code></pre>
<p>Now you can predict using the trained BRAIN.</p>

<h2 id="simulink-househeat">Simulink Househeat</h2>

<p>This is a step-by-step guide for using Bonsai&rsquo;s Universal Coordinator in Python to connect the Bonsai Platform to a Simulink model.</p>

<p>You have to have Matlab and Simulink installed. You can download a trial version from <a href="http://www.themathworks.com">TheMathworks</a></p>

<p>This example shows how to use Simulink to create the thermal model of a house. This system models the outdoor environment, the thermal characteristics of the house, and the house heating system. Objective for the Bonsai AI is to reach the desired temperature.</p>

<h4 id="cli-guide">CLI Guide</h4>

<p>We&rsquo;re using the Bonsai Command Line Interface (CLI) for this example. Refer to the <a href="http://docs.bons.ai/guides/cli-install-guide.html"><strong>Bonsai CLI guide</strong></a> for more details.</p>

<h4 id="pre-requisites-to-run-the-example">Pre-requisites to run the Example</h4>
<pre class="highlight plaintext"><code>pip install aiohttp
pip install bonsai-cli bonsai-ai bonsai-gym
</code></pre>
<p>Install Asynchronous HTTP Client/Server and the Bonsai CLI and Bonsai libraries needed to run our examples.</p>

<h4 id="install-matlab-engine">Install Matlab Engine:</h4>
<pre class="highlight plaintext"><code>cd &lt;matlabroot&gt;/extern/engines/python
python setup.py install
</code></pre>
<p>Install the Matlab API for Python from the root directory of your Matlab installation.</p>

<h4 id="running-and-training">Running and Training</h4>
<pre class="highlight plaintext"><code>bonsai create simulink-househeat
bonsai push
bonsai train start

../../coordinator/coordinator --brain=simulink-househeat
</code></pre>
<p>Run the following in the simulink-househeat directory:</p>

<p>The <code class="prettyprint">bonsai push</code> command will upload all needed files to the Bonsai backend. This includes an <a href="http://docs.bons.ai/references/inkling-reference.html"><strong>Inkling</strong></a> file which describes state, actions and a learning curriculum that the the Bonsai AI is using for training.</p>

<h6 id="inkling">Inkling</h6>

<p>Inkling is a declarative, strongly typed programming language specifically designed for artificial intelligence (AI). It abstracts away the world of dynamic AI algorithms that require expertise in machine learning and enables more developers to program AI.
Please review our <a href="http://docs.bons.ai/guides/inkling-guide.html#overview"><strong>Inkling Guide</strong></a></p>

<h6 id="schema">Schema</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">HouseheatState</span>
    <span class="kr">Float32</span> <span class="nx">set_temp</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">room_temp</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">room_temp_change</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">heat_cost</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">outside_temp</span><span class="p">,</span>
    <span class="kr">Float32</span> <span class="nx">outside_temp_change</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">HouseheatState</code> schema names six records  <code class="prettyprint">set_temp</code>.<code class="prettyprint">room_temp</code>,<code class="prettyprint">room_temp_change</code>,<code class="prettyprint">heat_cost</code>,<code class="prettyprint">outside_temp</code>, and <code class="prettyprint">outside_temp_change</code>  and assigns a type to them.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">HouseheatAction</span>
    <span class="kr">Float32</span><span class="p">{</span> <span class="mf">0.0</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.0</span> <span class="p">}</span> <span class="nx">heater_on</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">HouseheatAction</code> schema names a single record  <code class="prettyprint">heater_on</code>  and assigns a constrained type to it.</p>
<pre class="highlight inkling tab-inkling"><code><span class="k">schema</span> <span class="nx">HouseheatConfig</span>
    <span class="kr">Float32</span> <span class="nx">outside_phase</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">HouseheatConfig</code> schema names one record  <code class="prettyprint">outside_phase</code> - and assigns a type to it.</p>

<h6 id="concept">Concept</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">concept</span> <span class="nx">thermostat</span> <span class="k">is</span> <span class="nx">classifier</span>
   <span class="k">predicts</span> <span class="p">(</span><span class="nx">HouseheatAction</span><span class="p">)</span>
   <span class="k">follows</span> <span class="kr">input</span><span class="p">(</span><span class="nx">HouseheatState</span><span class="p">)</span>
   <span class="k">feeds</span> <span class="kr">output</span>
<span class="k">end</span>
</code></pre>
<p>The concept, <code class="prettyprint">thermostat</code>, takes input from the simulation model about the state of the temperature in the house (<code class="prettyprint">HouseheatState</code> schema). It outputs to the <code class="prettyprint">HouseheatAction</code> schema. This is the AI&rsquo;s next move in the game.</p>

<h6 id="simulator">Simulator</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">simulator</span> <span class="nx">simulink_sim</span><span class="p">(</span><span class="nx">HouseheatConfig</span><span class="p">)</span>
    <span class="k">action</span> <span class="p">(</span><span class="nx">HouseheatAction</span><span class="p">)</span>
    <span class="k">state</span> <span class="p">(</span><span class="nx">HouseheatState</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>The <code class="prettyprint">simulink_sim</code> gets information from two schemas. The first schema, <code class="prettyprint">action</code>, specifies the schema for actions within the simulation. The second schema, <code class="prettyprint">state</code> contains the state of the simulation sent to the lesson.</p>

<h6 id="curriculum">Curriculum</h6>
<pre class="highlight inkling tab-inkling"><code><span class="k">curriculum</span> <span class="nx">my_curriculum</span>
    <span class="k">train</span> <span class="nx">thermostat</span>
    <span class="k">with</span> <span class="k">simulator</span> <span class="nx">simulink_sim</span>
    <span class="k">objective</span> <span class="nx">match_set_temp</span>
        <span class="k">lesson</span> <span class="nx">my_first_lesson</span>
            <span class="k">configure</span>
            <span class="k">constrain</span> <span class="nx">outside_phase</span> <span class="k">with</span> <span class="kr">Float32</span><span class="p">{</span><span class="mf">0.0</span><span class="p">:</span><span class="mf">48.0</span><span class="p">}</span>
            <span class="k">until</span>
                <span class="k">maximize</span> <span class="nx">match_set_temp</span>
<span class="k">end</span>
</code></pre>
<p>The curriculum, <code class="prettyprint">my_curriculum</code>, trains the <code class="prettyprint">thermostat</code> concept using the <code class="prettyprint">simulink_sim</code>. This curriculum contains one lesson, called <code class="prettyprint">my_first_lesson</code>. It configures the simulation, by setting constraints for the state of the simulator.</p>

<p>The lesson trains until the AI has maximized the objective named <code class="prettyprint">match_set_temp</code>.</p>

<h6 id="predicting-with-a-brain">Predicting with a BRAIN</h6>
<pre class="highlight plaintext"><code>bonsai train stop
</code></pre>
<p>When you are seeing rewards reaching &gt;100 you can stop training. You may need to Ctrl+C to stop in the terminal.</p>
<pre class="highlight plaintext"><code>../../coordinator/coordinator --predict
</code></pre>
<p>Now you can predict using the trained BRAIN.</p>

<h2 id="using-simulink-coder-for-parallel-simulations">Using Simulink Coder for Parallel Simulations</h2>

<p>Simulink Coder provides a mechanism to compile Simulink models as a fast running C executable file for your operating system. Three main benefits to training Bonsai BRAINs with these executables are as follows.</p>

<p>First, is that Simulink Coder executables return simulations results much faster than raw Simulink files. When training a BRAIN using Deep Reinforcement Learning, this difference in speed can add up. For example, if you train a BRAIN for 1M iterations with a Simulink Coder executable that runs in 0.5s per iteration instead of 1.5s per iteration, your total training time will decrease by 277 hours!</p>

<p>Second, Simulink Coder executables are much easier to connect to the Bonsai platform in parallel because they require a lot less memory and CPU than instances of interactive Simulink models. Continuing the example above, if you run 100 copies your new coder executable in parallel training you&rsquo;ve now reduced the training time by about 250 hours.</p>

<p>Lastly, Simulink Coder executable models allow you to share with people and teams using Simulink to train Bonsai BRAINS without a Matlab or Simulink license.</p>

<p>Visit The Mathworks for more information on <a href="https://www.mathworks.com/products/simulink-coder.html"><strong>Matlab and Simulink Coder</strong></a></p>

<h2 id="how-to-connect-your-own-model">How to connect your own model</h2>

<p>Please review the <code class="prettyprint">HOWTO.md</code> file in the downloaded folder for more information on how to connect your own Simulink model to the Bonsai AI platform.</p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="python">python</a>
                <a href="#" data-language-name="cpp">cpp</a>
          </div>
      </div>
    </div>

    </div>

  </div>
  <!-- at the end of the BODY -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
  <script type="text/javascript"> docsearch({
  apiKey: '49fa6f01d7ff94a85b9b7434b1c2b7cf',
  indexName: 'bon-sai',
  inputSelector: '#docs-search',
  debug: false // Set debug to true if you want to inspect the dropdown
  });
  </script>
  </body>
</html>
